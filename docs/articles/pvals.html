<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simultaneous confidence intervals and p-values • metagam</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Simultaneous confidence intervals and p-values">
<meta property="og:description" content="metagam">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">metagam</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/dominance.html">Dominance analysis</a>
    </li>
    <li>
      <a href="../articles/heterogeneity.html">Heterogeneity analysis</a>
    </li>
    <li>
      <a href="../articles/multivariate.html">Multivariate smooth terms</a>
    </li>
    <li>
      <a href="../articles/pvals.html">Simultaneous confidence intervals and p-values</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Lifebrain/metagam/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="pvals_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Simultaneous confidence intervals and p-values</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Lifebrain/metagam/blob/master/vignettes/pvals.Rmd"><code>vignettes/pvals.Rmd</code></a></small>
      <div class="hidden name"><code>pvals.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://lifebrain.github.io/metagam/">"metagam"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"mgcv"</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: nlme</span>
<span class="co">#&gt; This is mgcv 1.8-38. For overview type 'help("mgcv-package")'.</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://www.metafor-project.org">"metafor"</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: Matrix</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Loading the 'metafor' package (version 3.0-2). For an</span>
<span class="co">#&gt; introduction to the package please type: help(metafor)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org">"ggplot2"</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Previous versions of metagam had built-in aggregation of p-values, using the <a href="https://cran.r-project.org/package=metap">metap</a> package. However, this had two drawbacks:</p>
<ul>
<li>metap depends on multtest, which is a Bioconductor package, and this dependency made the installation of metagam unnecessarily complicated.</li>
<li>Aggregation of p-values might not always make sense for smooth terms. (Thanks to Alexandre Loureiro for discovering this!)</li>
</ul>
<p>This vignette briefly describes the latter issue, and shows how the metap package can be used directly on output from metagam.</p>
<div id="what-can-go-wrong-when-combining-p-values" class="section level2">
<h2 class="hasAnchor">
<a href="#what-can-go-wrong-when-combining-p-values" class="anchor"></a>What can go wrong when combining p-values?</h2>
<p>Consider the two datasets below, which have completely opposite effects. I have also included the code for simulating the data.</p>
<p><img src="pvals_files/figure-html/unnamed-chunk-2-1.png" width="700"><img src="pvals_files/figure-html/unnamed-chunk-2-2.png" width="700"></p>
<p>Fitting a GAM to each dataset separately, we see that the effect is significant at <span class="math inline">\(\alpha = 0.05\)</span> level.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dd</span><span class="op">$</span><span class="va">dat1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Family: gaussian </span>
<span class="co">#&gt; Link function: identity </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Formula:</span>
<span class="co">#&gt; y ~ s(x, bs = "cr")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Parametric coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)  0.50554    0.06587   7.674 1.25e-11 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Approximate significance of smooth terms:</span>
<span class="co">#&gt;      edf Ref.df     F  p-value    </span>
<span class="co">#&gt; s(x)   1      1 24.26 3.61e-06 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; R-sq.(adj) =   0.19   Deviance explained = 19.8%</span>
<span class="co">#&gt; GCV = 0.4428  Scale est. = 0.43394   n = 100</span>

<span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dd</span><span class="op">$</span><span class="va">dat2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Family: gaussian </span>
<span class="co">#&gt; Link function: identity </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Formula:</span>
<span class="co">#&gt; y ~ s(x, bs = "cr")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Parametric coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept) -0.46800    0.07367  -6.352 6.72e-09 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Approximate significance of smooth terms:</span>
<span class="co">#&gt;        edf Ref.df     F p-value   </span>
<span class="co">#&gt; s(x) 1.237  1.436 10.65 0.00112 **</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; R-sq.(adj) =  0.117   Deviance explained = 12.8%</span>
<span class="co">#&gt; GCV = 0.55517  Scale est. = 0.54275   n = 100</span></code></pre></div>
<p>Now let us try a metagam fit.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/strip_rawdata.html">strip_rawdata</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span>, <span class="fu"><a href="../reference/strip_rawdata.html">strip_rawdata</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span><span class="op">)</span>
<span class="va">metafit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metagam.html">metagam</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span></code></pre></div>
<p>Plotting the meta-analytic fit, we see that the 95 % confidence bands completely cover zero.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">metafit</span><span class="op">$</span><span class="va">meta_estimates</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">estimate</span>, ymin <span class="op">=</span> <span class="va">ci.lb</span>, ymax <span class="op">=</span> <span class="va">ci.ub</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></code></pre></div>
<p><img src="pvals_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The object returned by <code>metagam</code> has a <code>pvals</code> element which contains p-values for each term in each individual fit.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">metafit</span><span class="op">$</span><span class="va">pvals</span>
<span class="co">#&gt;       term      edf   Ref.df        F      p-value</span>
<span class="co">#&gt; s(x)  s(x) 1.000000 1.000000 24.25930 3.612591e-06</span>
<span class="co">#&gt; s(x)1 s(x) 1.236565 1.436059 10.64571 1.121220e-03</span></code></pre></div>
<p>Combining the p-values using any of the methods available in metap, we do however see that the effects are signficiant at <span class="math inline">\(\alpha = 0.05\)</span>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://www.dewey.myzen.co.uk/meta/meta.html">"metap"</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/metap/man/allmetap.html">allmetap</a></span><span class="op">(</span>p <span class="op">=</span> <span class="va">metafit</span><span class="op">$</span><span class="va">pvals</span><span class="op">$</span><span class="va">`p-value`</span>, method <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt;                     p valid    eponym
#&gt; logitp   5.618196e-07     2          
#&gt; maximump 1.257134e-06     2          
#&gt; meanp              NA     2          
#&gt; meanz    6.758351e-08     2          
#&gt; minimump 7.225169e-06     2   Tippett
#&gt; sumlog   8.232425e-08     2    Fisher
#&gt; sump      6.32624e-07     2 Edgington
#&gt; sumz     4.810753e-08     2  Stouffer</code></pre>
<p>This happens because combination of p-values is not aware of the direction of the effects. Hence, rather than having this a part of the package, we suggest that users who know what they’re doing combine the p-values using metap package.</p>
<p>For comparison, fitting a linear model to each dataset and combining the slopes using <code>metafor</code> gives a p-value 0.9296, which makes a lot more sense.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">dd</span><span class="op">$</span><span class="va">dat1</span><span class="op">)</span>
<span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">dd</span><span class="op">$</span><span class="va">dat2</span><span class="op">)</span>

<span class="va">estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://wviechtb.github.io/metafor/reference/coef.rma.html">coef</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span><span class="op">[[</span><span class="st">"x"</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://wviechtb.github.io/metafor/reference/coef.rma.html">coef</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span><span class="op">[[</span><span class="st">"x"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">sampling_variances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://wviechtb.github.io/metafor/reference/vcov.rma.html">vcov</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span><span class="op">[[</span><span class="st">"x"</span>, <span class="st">"x"</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://wviechtb.github.io/metafor/reference/vcov.rma.html">vcov</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span><span class="op">[[</span><span class="st">"x"</span>, <span class="st">"x"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://wviechtb.github.io/metafor/reference/rma.uni.html">rma</a></span><span class="op">(</span><span class="va">estimates</span>, vi <span class="op">=</span> <span class="va">sampling_variances</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random-Effects Model (k = 2; tau^2 estimator: REML)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; tau^2 (estimated amount of total heterogeneity): 2.4526 (SE = 3.5661)</span>
<span class="co">#&gt; tau (square root of estimated tau^2 value):      1.5661</span>
<span class="co">#&gt; I^2 (total heterogeneity / total variability):   97.26%</span>
<span class="co">#&gt; H^2 (total variability / sampling variability):  36.54</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Test for Heterogeneity:</span>
<span class="co">#&gt; Q(df = 1) = 36.5396, p-val &lt; .0001</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model Results:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; estimate      se    zval    pval    ci.lb   ci.ub </span>
<span class="co">#&gt;   0.0992  1.1229  0.0884  0.9296  -2.1015  2.3000    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></code></pre></div>
</div>
<div id="a-better-way-to-compute-p-values" class="section level2">
<h2 class="hasAnchor">
<a href="#a-better-way-to-compute-p-values" class="anchor"></a>A better way to compute p-values?</h2>
<div id="simultaneous-confidence-intervals" class="section level3">
<h3 class="hasAnchor">
<a href="#simultaneous-confidence-intervals" class="anchor"></a>Simultaneous confidence intervals</h3>
<p>Let’s create another GAM fit, this time using the <code>gamSim</code> function. The dashed lines in the plot correspond to two standard errors above and below the estimate. However, this is a pointwise confidence interval, which for our practical purposes means that under repeated sampling from the population, it will contain the true function less than 95 % of the times. See, e.g., Chapter 6.5 of <span class="citation">Ruppert, Wand, and Carroll (2003)</span>, <span class="citation">Sørensen, Walhovd, and Fjell (2021)</span> or <a href="https://fromthebottomoftheheap.net/2016/12/15/simultaneous-interval-revisited/">this blog post</a>. What we need is a simultaneous confidence interval.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gamSim.html">gamSim</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x0</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<p><img src="pvals_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>We see that the critical value for a 95 % simultaneous interval is above 2.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">masd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getmasd.html">getmasd</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">grid</span>, <span class="fl">10000</span>, terms <span class="op">=</span> <span class="st">"s(x0)"</span><span class="op">)</span>
<span class="op">(</span><span class="va">crit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">masd</span>, prob <span class="op">=</span> <span class="fl">.95</span>, type <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;      95% </span>
<span class="co">#&gt; 2.405748</span></code></pre></div>
<p>We can plot the two together, and we see that the simultaneous confidence interval is bigger.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://wviechtb.github.io/metafor/reference/predict.rma.html">predict</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">grid</span>, se.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  x0 <span class="op">=</span> <span class="va">grid</span><span class="op">$</span><span class="va">x0</span>,
  pred <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">fit</span>,
  ci_pt_lb <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">fit</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.025</span><span class="op">)</span> <span class="op">*</span> <span class="va">fit</span><span class="op">$</span><span class="va">se.fit</span>,
  ci_pt_ub <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">fit</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.975</span><span class="op">)</span> <span class="op">*</span> <span class="va">fit</span><span class="op">$</span><span class="va">se.fit</span>,
  ci_sim_lb <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">fit</span> <span class="op">-</span> <span class="va">crit</span> <span class="op">*</span> <span class="va">fit</span><span class="op">$</span><span class="va">se.fit</span>,
  ci_sim_ub <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">fit</span> <span class="op">+</span> <span class="va">crit</span> <span class="op">*</span> <span class="va">fit</span><span class="op">$</span><span class="va">se.fit</span>
<span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x0</span>, y <span class="op">=</span> <span class="va">pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ci_pt_lb</span>, ymax <span class="op">=</span> <span class="va">ci_pt_ub</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ci_sim_lb</span>, ymax <span class="op">=</span> <span class="va">ci_sim_ub</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span></code></pre></div>
<p><img src="pvals_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div id="combining-simultaneous-confidence-intervals" class="section level3">
<h3 class="hasAnchor">
<a href="#combining-simultaneous-confidence-intervals" class="anchor"></a>Combining simultaneous confidence intervals</h3>
<p>In the current version of metagam, it is possible to combine simultaneous confidence intervals for each separate fit. The critical value multiplied by the standard errors is then used as the weight when it is meta analytically combined. Significance testing can be done by checking if it is possible to fit a constant function within the simultaneous confidence bands, which is the same as checking whether the maximum of the lower band across the range of x-values is larger than the minimum of the upper band across the range of x-values. We illustrate it here.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">124</span><span class="op">)</span>
<span class="va">datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gamSim.html">gamSim</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">5</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>

<span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">datasets</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">{</span>
  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x2</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span>
  <span class="fu"><a href="../reference/strip_rawdata.html">strip_rawdata</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">meta_analysis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metagam.html">metagam</a></span><span class="op">(</span><span class="va">models</span>, terms <span class="op">=</span> <span class="st">"s(x2)"</span>, grid_size <span class="op">=</span> <span class="fl">100</span>,
                         nsim <span class="op">=</span> <span class="fl">10000</span>, ci_alpha <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span></code></pre></div>
<p>Convenience functions will be added later, but for now it is a bit manual. Notice that the outer bands are bigger.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_conf</span> <span class="op">&lt;-</span> <span class="va">meta_analysis</span><span class="op">$</span><span class="va">sim_ci</span>
<span class="va">ptw_conf</span> <span class="op">&lt;-</span> <span class="va">meta_analysis</span><span class="op">$</span><span class="va">meta_estimates</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">sim_conf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ci_sim_lb</span>, ymax <span class="op">=</span> <span class="va">ci_sim_ub</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ptw_conf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ci.lb</span>, ymax <span class="op">=</span> <span class="va">ci.ub</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span></code></pre></div>
<p><img src="pvals_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>The p-value is printed with the model summary. In order to get more digits after the decimal point in the p-value, increase the <code>nsim</code> argument.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">meta_analysis</span><span class="op">)</span>
<span class="co">#&gt; Meta-analysis of GAMs from 5 cohorts, using method FE.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Smooth terms analyzed: s(x2). P-value for smooth term: &lt;1e-04</span></code></pre></div>
</div>
<div id="does-it-work" class="section level3">
<h3 class="hasAnchor">
<a href="#does-it-work" class="anchor"></a>Does it work?</h3>
<p>We shouldn’t trust a single example, so here we will show some simulations. We do this by simulating a case where the true relationship is zero, and check if the distribution of p-values is close to uniform?</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">pvals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">parLapply</a></span><span class="op">(</span>
  cl <span class="op">=</span> <span class="va">cl</span>, X <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span>
      <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span>
      <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span>
      <span class="fu">metagam</span><span class="fu">::</span><span class="fu"><a href="../reference/strip_rawdata.html">strip_rawdata</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
      <span class="op">}</span><span class="op">)</span>
    <span class="fu">metagam</span><span class="fu">::</span><span class="fu"><a href="../reference/metagam.html">metagam</a></span><span class="op">(</span><span class="va">models</span>, nsim <span class="op">=</span> <span class="fl">1000</span>, ci_alpha <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span><span class="op">$</span><span class="va">meta_pval</span>
  <span class="op">}</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">qunif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span>, 
     <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">pvals</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
     xlab <span class="op">=</span> <span class="st">"Theoretical quantile"</span>,
     ylab <span class="op">=</span> <span class="st">"Data quantile"</span><span class="op">)</span></code></pre></div>
<p><img src="figures/quantile_plot.png"></p>
<p>The quantile plot above looks sufficiently satisfactory to include this in the package. We will conduct much more extensive simulation studies in a future paper.</p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Ruppert2003" class="csl-entry">
Ruppert, David, M. P. Wand, and R. J. Carroll. 2003. <em>Semiparametric Regression</em>. Cambridge University Press, Cambridge, U.K.
</div>
<div id="ref-Sorensen2021b" class="csl-entry">
Sørensen, Øystein, Kristine B. Walhovd, and Anders M. Fjell. 2021. <span>“A Recipe for Accurate Estimation of Lifespan Brain Trajectories, Distinguishing Longitudinal and Cohort Effects.”</span> <em>NeuroImage</em> 226 (February): 117596. <a href="https://doi.org/10.1016/j.neuroimage.2020.117596">https://doi.org/10.1016/j.neuroimage.2020.117596</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Oystein Sorensen, Andreas M. Brandmaier, Athanasia Mo Mowinckel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
